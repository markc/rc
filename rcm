#!/usr/bin/env bash
# Created: 20250930 - Updated: 20250930
# Copyright (C) 1995-2025 Mark Constable <markc@renta.net> (AGPL-3.0)
# RC Manager - Manages ~/.rc runtime configuration directory

# Help function
help() {
    case $1 in
        i|init)
            echo "Initialize ~/.rc structure and create local _myrc"
            echo "Usage: rcm init"
            ;;
        s|sync)
            echo "Sync ~/.rc directory to remote host"
            echo "Usage: rcm sync <ssh_host>"
            echo "Example: rcm sync myserver"
            echo "Note: Excludes _myrc (local customizations)"
            ;;
        *)
            echo "Usage: rcm <cmd> [args]"
            echo "Commands: init, sync, help"
            echo ""
            echo "For SSH management use: sshm"
            ;;
    esac
}

[[ -z $1 || $1 =~ -h ]] && help && exit 1

# Initialize RC structure
init() {
    # Create user customization file from template if missing
    if [[ ! -f ~/.rc/_myrc ]]; then
        if [[ -f ~/.rc/_myrc.example ]]; then
            cp ~/.rc/_myrc.example ~/.rc/_myrc
            echo "‚úÖ Created ~/.rc/_myrc from template"
            echo "‚ÑπÔ∏è  Edit ~/.rc/_myrc to add your customizations"
        else
            # Fallback if template doesn't exist
            cat > ~/.rc/_myrc << 'MYRC'
# Personal shell customizations
# This file is local to this machine and not synced

# Add your custom aliases, functions, and environment variables here
# Examples:
# alias myproject='cd ~/projects/myproject'
# export MY_VAR="value"

MYRC
            echo "‚úÖ Created ~/.rc/_myrc for local customizations"
        fi
    else
        echo "‚ÑπÔ∏è  ~/.rc/_myrc already exists"
    fi

    echo "‚úÖ RC structure initialized"
}

# Sync ~/.rc directory to remote host
sync() {
    local ssh_host="$1"

    if [[ -z "$ssh_host" ]]; then
        echo "‚ùå Error: SSH host required"
        echo "Usage: rcm sync <ssh_host>"
        exit 1
    fi

    # Check if SSH host exists in config
    if ! grep -q "^Host $ssh_host$" ~/.ssh/hosts/* 2>/dev/null; then
        echo "‚ö†Ô∏è  Warning: SSH host '$ssh_host' not found in ~/.ssh/hosts/"
        echo "Attempting connection anyway..."
    fi

    echo "üîÑ Syncing ~/.rc/ to $ssh_host:~/.rc/ (excluding _myrc)..."
    rsync -avz --exclude='_myrc' --exclude='.git' ~/.rc/ "$ssh_host":~/.rc/

    if [[ $? -eq 0 ]]; then
        echo "‚úÖ Sync completed successfully"
        echo "‚ÑπÔ∏è  Run: ssh $ssh_host \"~/.rc/rcm init\""
        echo "   to initialize remote _myrc customizations"
    else
        echo "‚ùå Sync failed"
        exit 1
    fi
}

# Command handler
case $1 in
    i|init) init ;;
    s|sync) sync $2 ;;
    h|help) help $2 ;;
    *) echo "Unknown command '$1'" && help ;;
esac

exit 0
